# ［C++］モジュール

# メモ

- module unit : モジュール単位
モジュールを構成する翻訳単位
ファイル先頭のモジュール宣言によりモジュール単位は開始される
その後にimport宣言が続く（なくてもよい

モジュール宣言
```cpp
module foo;  //ファイル先頭で行う
```

- module interface unit : モジュールインターフェース単位
module unitであり、モジュール宣言にexportを伴うもの

モジュールインターフェース宣言
```cpp
export module foo;  //ファイル先頭で行う
```

モジュールのインターフェースを定義する
インターフェース：シグネチャ、宣言みたいな
モジュールには少なくとも一つがモジュールインターフェース単位である必要がある

- primary module interface unit : プライマリモジュールインターフェース単位
モジュールインターフェース単位を含むモジュール単位

- module interface partitions : モジュールインタフェースパーティション
プライマリではないすべてのモジュールインターフェース単位

## visibale と reachable

- visible : 可視
名前探索によって宣言が見つかれば、そのコンテキストでその宣言は可視である

- reachable : 到達可能
定義（意味論的効果）が使用可能である場合、そのコンテキストでその宣言は到達可能である
例えば、あるコンテキストでクラスが完全型であるならば、そのクラスの定義は到達可能である

宣言は可視 -> 到達可能 : true
到達可能 -> 宣言は可視 : false (trueとなることもある)

importはどの名前空間スコープの名前が可視になるか
および、どの宣言が意味論的に（semantically）到達可能か
だけをコントロールする。

あるエンティティの振る舞いは、そのエンティティの到達可能な宣言の集合によって決まる（エンティティ = 名前・定義？）
例えば、クラス・列挙体のメンバはその定義が到達可能であるとき、名前探索で可視である

## export
宣言は`export`を用いてモジュールインターフェース単位内でエクスポートできる

内部リンケージを持つものを除いて、エクスポートされていない宣言はそのモジュール単位をインポートする同じモジュール内の名前探索で可視である

推移的にインポートされたモジュール単位内のすべての宣言は、エクスポートされているかにかかわらず到達可能（？？

モジュール単位は対応するモジュールインタフェース単位を暗黙にインポートする

名前空間内の宣言（名前空間を伴う宣言）がエクスポートされると、その名前空間も暗黙的にエクスポートされる。
名前空間をエクスポートすると、名前空間内の宣言は（暗黙的に）エクスポートされる。

## module partitions : モジュールパーティション

一つのモジュールは単一のファイルでも複数のファイルでも定義できる。  
例えば、宣言（モジュールインターフェースユニット）と定義（実装）をファイルで分割することができる。

モジュールパーティションは、そのようなインターフェースと実装を分割することを可能にする

- module interface partitions : モジュールインターフェースパーティション

モジュールインターフェースは必要に応じて複数のファイルに分割することができる。
それらのファイルをモジュールインターフェースパーティションと呼ぶ。
以下のようなモジュールインターフェースパーティション宣言を（その他のモジュール宣言の代わりに）含む翻訳単位のこと。

モジュールインターフェースパーティション宣言
```cpp
export module foo::part;
```

モジュールインターフェースパーティションに含まれるエンティティの所有権は属しているモジュールと共有される。  
それ以外は、モジュールインターフェースパーティションは単一のモジュールと同じ振る舞いをする。  

そのため、エンティティの宣言と定義を別々のパーティションで行うことができる
これは、モジュール内部で発生しうる循環参照（依存関係のループ）を解決するために必要
これはまた、ABIを変えることなくモジュール内でコードを移動することができる

プライマリモジュールインターフェース単位は、モジュール内のすべてのインターフェースパーティションの推移的インポートと再エクスポートをしなければならない。

- module implementation partitions : モジュール実装区分

モジュール内で実装が複数のファイルに分割されており、モジュール内で他のモジュールインターフェースパーティションで定義されたものを使用している場合、実装の詳細（定義）に依存することを避けるために、宣言をモジュールインターフェース単位に含めずに実装単位間で共有することが望ましいことがある
そうすることで、定義が変更されたときにモジュールインターフェースとその依存関係を再構築する必要がなくなる
それを可能にするのが モジュール実装区分である。

モジュール実装区分宣言
```cpp
module foo:part;
```
これは、モジュールインターフェース単位の一部ではないモジュールパーティションとなる

モジュール実装区分はエクスポートされた宣言を含めることができない
代わりに、モジュール実装区分をインポートすることで、そのモジュール実装区分のすべての宣言は同じモジュール内の他の翻訳単位から可視となる

`export`はモジュール外部への名前と宣言の可視性にのみ影響を与える。

- module partitions : モジュールパーティション
モジュールインタフェースパーティションとモジュール実装区分はまとめて、モジュールパーティションと呼ぶ

モジュールパーティションはモジュールの実装の詳細であり、その名前をモジュール外部から参照することはできない
そのため、モジュールパーティションを指名する`import`宣言はモジュール名を指定できず、パーティション名のみを指定することができる


