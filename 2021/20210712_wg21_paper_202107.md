# ［C++］WG21月次提案文書を眺める（2021年06月）

文書の一覧

- [JTC1/SC22/WG21 - Papers 2021 mailing2021-06](http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2021/#mailing2021-06)

全部で49本あり、SG22（C/C++相互互換性に関する研究グループ）のCの提案を除くと48本になります。

[:contents]

### [N4887 PL22.16/WG21 agenda: 7 June 2021, Virtual Meeting](http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2021/n4887.html)

2021年6月7日 11:00 (北米時間)に行われたWG21本会議のアジェンダです。

C++23のための3回目の全体会議です。

### [N4888 WG21 virtual meetings: 2021-06, and -10](http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2021/n4888.pdf)

今年のWG21全体会議の予定表。

次は10月に予定されています。これもオンラインで行われることが決定しています。

### [N4889 WG21 admin telecon meeting: 2021-09](http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2021/n4889.pdf)

10月の全体会議の直前に行われる管理者ミーティングの予定表。

### [N4890 WG21 2021-05 Admin telecon minutes](http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2021/n4890.pdf)

2021年5月24日に行われた、管理者ミーティングの議事録。

### [N4891 WG21 2021-06 Virtual Meeting Minutes of Meeting](http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2021/n4891.pdf)

2021年2月22日（米国時間）に行われた、WG21全体会議の議事録。

CWG/LWGの投票の様子などが記載されています。

### [N4892 Working Draft, Standard for Programming Language C++](http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2021/n4892.pdf)

C++23ワーキングドラフト第5弾。

### [N4893 Editors' Report - Programming Languages - C++](http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2021/n4893.html)

↑の変更点をまとめた文書。

6月の会議で採択された提案とコア言語/ライブラリのIssue解決が適用されています。

### [P0205R1 Efficient Seeding of Random Number Engines](http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2021/p0205r1.html)

乱数シードの生成ヘルパーである`std::seed_adapter`を追加する提案。

`<random>`の乱数エンジンを使用する際、次の様に初期化を行うのが非常に一般的です。

```cpp
template <typename EngineT>
void seed_non_deterministically_1st(EngineT& engine) {
  std::random_device device{};
  engine.seed(device());
}
```

しかし、`EngineT`の内部状態が大きい場合、この初期化は適切ではありません。より良い乱数の生成のためには内部状態の初期値が全て偏りなく初期化されている必要がありますが、たとえば`std::mt19937`の場合その内部状態は19968bitある一方で、`random_device`の戻り値型は`unsigned int`であり多くの環境で32bitの大きさしかなく、初期状態の選択に偏りが生じます。それによって、エンジンが生成する乱数値にも偏りが生じる事があリます。

この様な問題に対処するために、[`std::seed_seq`](https://cpprefjp.github.io/reference/random/seed_seq.html)を利用する事ができます。`std::seed_seq`はシード列を表現するための型で、イテレータ範囲などによって任意の数の整数値から初期化し、それによって生成される32bit整数によるシード列を`.generate()`メンバ関数から取得する事ができます。あるいは、エンジンの`.seed()`メンバ関数に渡すこともできます。

```cpp
template <typename EngineT, std::size_t StateSize = EngineT::state_size>
void seed_non_deterministically_2nd(EngineT& engine) {
  using engine_type = typename EngineT::result_type;
  using device_type = std::random_device::result_type;
  using seedseq_type = std::seed_seq::result_type;

  constexpr auto bytes_needed = StateSize * sizeof(engine_type);
  constexpr auto numbers_needed = (sizeof(device_type) < sizeof(seedseq_type))
      ? (bytes_needed / sizeof(device_type))
      : (bytes_needed / sizeof(seedseq_type));

  // シード列のシード？を生成
  std::array<device_type, numbers_needed> numbers{};
  std::random_device device{};
  std::generate(std::begin(numbers), std::end(numbers), std::ref(device));

  // シード列によるエンジンの初期化
  std::seed_seq seedseq(std::cbegin(numbers), std::cend(numbers));
  engine.seed(seedseq);
}
```

このコードにはいくつか問題があります。

- 複雑
- 乱数エンジンはその状態サイズを公開していない（あるいは、そう規定していない）
- 正確ではない（`std::seed_seq`は偏りをもたらしうる）
- 非効率
    - `std::random_device` -> `std::array`（スタック） -> `std::seed_seq`（ヒープ）とコピーされる
    - `std::random_device`は必要となる乱数のサイズを取らないため、実装によっては乱数取得が非効率になる

この提案は、この様なシード列による乱数エンジンの初期化という作業を効率的かつ簡易に行うための`std::seed_adapter`を提案するものです。

```cpp
template <typename EngineT>
void seed_non_deterministically_3rd(EngineT& engine) {
  std::random_device device{};
  std::seed_adapter adapter{device};
  engine.seed(adapter);
}
```

`std::seed_adapter`は余分なコピーや一時オブジェクトが不要で、動的メモリ確保を必要とせず、偏りを導入しないシード列を表現する型です。

`std::seed_adapter`は任意の*Uniform Random Bit Generator*クラス（例えば`std::random_device`）の参照をラップし、その関数呼び出し演算子を呼び出す`.generate()`メンバ関数を提供するクラステンプレートです。

[P1068R4](https://wg21.link/P1068R4)が採択された場合、ラップしている*Generator*クラスの関数呼び出し演算子は一度だけ呼び出せば良くなります。採択されない場合でも、例えば`std::seed_adapter`の実装に合わせた最適な呼び出しをサポートする事が可能です。

`std::seed_adapter`は例えば次の様な小さなクラス型になります。

```cpp
template <uniform_random_bit_generator U>
class seed_adapter {
public:
  // types
  using result_type = typename U::result_type;

  // constructors
  explicit constexpr seed_adapter(U& gen) noexcept;

  // generating functions
  template <random_access_iterator It>
    void constexpr generate(const It f, const It l)
    requires __unsigned_integral_least32<typename iterator_traits<It>::value_type>;

private:
  U* m_gen;  // exposition only
};
```

- [P0205R1 進行状況](https://github.com/cpSlusplus/papers/issues/325)

### [P0447R15 Introduction of std::hive to the standard library](http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2021/p0447r15.html)
### [P0533R7 constexpr for cmath and cstdlib](http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2021/p0533r7.pdf)
↓
### [P0533R8 constexpr for cmath and cstdlib](http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2021/p0533r8.pdf)
### [P1018R11 C++ Language Evolution status - pandemic edition - 2021/05](http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2021/p1018r11.html)
### [P1072R8 basic_string::resize_and_overwrite](http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2021/p1072r8.html)
### [P1132R8 `out_ptr` - a scalable output pointer abstraction](http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2021/p1132r8.html)
### [P1202R3 Asymmetric Fences](http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2021/p1202r3.pdf)
### [P1642R6 Freestanding Library: Easy [utilities], [ranges], and [iterators]](http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2021/p1642r6.html)
### [P1664R4 reconstructible_range - a concept for putting ranges back together](http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2021/p1664r4.html)
### [P1675R2 `rethrow_exception` must be allowed to copy](http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2021/p1675r2.pdf)
### [P1689R4 Format for describing dependencies of source files](http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2021/p1689r4.html)
### [P1708R5 Simple Statistical Functions](http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2021/p1708r5.pdf)
### [P1967R4 `#embed` - a simple, scannable preprocessor-based resource acquisition method](http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2021/p1967r4.html)
### [P2164R5 `views::enumerate`](http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2021/p2164r5.pdf)
### [P2165R2 Compatibility between tuple, pair and tuple-like objects](http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2021/p2165r2.pdf)
### [P2290R1 Delimited escape sequences](http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2021/p2290r1.pdf)
### [P2295R4 Support for UTF-8 as a portable source file encoding](http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2021/p2295r4.pdf)
### [P2299R3 `mdspan`s of All Dynamic Extents](http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2021/p2299r3.html)
### [P2300R0 `std::execution`](http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2021/p2300r0.html)
### [P2301R1 Add a pmr alias for std::stacktrace](http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2021/p2301r1.html)
### [P2321R2 `zip`](http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2021/p2321r2.html)
### [P2322R3 `ranges::fold`](http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2021/p2322r3.html)
### [P2340R1 Clarifying the status of the "C headers"](http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2021/p2340r1.html)
### [P2347R0 Argument type deduction for non-trailing parameter packs](http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2021/p2347r0.pdf)
### [P2361R1 Unevaluated string literals](http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2021/p2361r1.pdf)
### [P2368R1 2021 Spring Library Evolution Polls](http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2021/p2368r1.html)
### [P2370R0 Stacktrace from exception](http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2021/p2370r0.html)
### [P2380R1 reference_wrapper Associations](http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2021/p2380r1.pdf)
### [P2384R0 2021 Spring Library Evolution Poll Outcomes](http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2021/p2384r0.html)
### [P2385R0 C++ Standard Library Issues to be moved in Virtual Plenary, June 2021](http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2021/p2385r0.html)
### [P2386R0 Core Language Working Group "ready" Issues for the June, 2021 meeting](http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2021/p2386r0.html)
### [P2387R0 Pipe support for user-defined range adaptors](http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2021/p2387r0.html)
### [P2388R0 Abort-only contract support](http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2021/p2388r0.html)
### [P2390R0 Add annotations for unreachable control flow](http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2021/p2390r0.pdf)
### [P2392R0 Pattern matching using “is” and “as”](http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2021/p2392r0.pdf)
### [P2393R0 Cleaning up integer-class types](http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2021/p2393r0.html)
### [P2395R0 WG21 2021-06 Virtual Meeting Record of Discussion](http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2021/p2395r0.pdf)
### [P2396R0 Concurrency TS 2 fixes](http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2021/p2396r0.pdf)
### [P2397R0 SG16: Unicode meeting summaries 2021-04-14 through 2021-05-26](http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2021/p2397r0.html)
### [P2400R1 Library Evolution Report: 2021-02-23 to 2021-05-25](http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2021/p2400r1.html)