# ［C++］WG21月次提案文書を眺める（2023年05月）

文書の一覧

- [JTC1/SC22/WG21 - Papers 2022 mailing2023-05](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2023/#mailing2023-05)

SG22のWG14からのものを除いて、全部で41本あります。

[:contents]

### P2654R0 Macros And Standard Library Modules

標準ライブラリで提供されるマクロを、標準ライブラリモジュール（`std.compat`）からエクスポートするようにする提案。

C++23から`std/std.compat`モジュールが提供されるようになり、標準ライブラリの全体をモジュールとしてインポートできるようになります。ただし、これには標準ライブラリ（特に、C互換ヘッダ）でマクロとして提供される機能が含まれていません。

これはモジュールの仕様に基づくもので、名前付きモジュールからはマクロをエクスポートすることができないためです。この制限がないヘッダユニットと呼ばれる、従来のヘッダファイルをモジュールとして`import`する方法もありこちらはマクロもエクスポートされますが、標準ライブラリのC互換ヘッダはヘッダユニットとして`import`可能であるかは実装定義です。

結局、標準のマクロ機能を使用しようとすると、従来のヘッダファイルのインクルード以外に手段がありません。

この提案は、モジュールにおけるマクロの扱いに変更を加えることなくこの制限を取り除くために、標準ライブラリ中でマクロとして提供される機能の代替提供手段を検討するものです。

この提案では、その対象として次のものを挙げています

- リテラル値に置換されるマクロ
    - これらは`#if`ディレクティブで多用されるため、`constexpr`変数で置換できない
    - テキスト置換を行わない新しいプリプロセッシングディレクティブにより解決（別提案）
- `assert`
    - このマクロはC++においては様々な問題を抱えている
    - P2884R0では、`assert`をキーワード化して演算子として使用するようにすることを提案しており、懸念事項が取り上げられている
- `offsetof`
    - P2883R0で議論
- `setjmp/longjmp`
    - C++オブジェクトモデル及びオブジェクト生存期間の概念と直接関わるもの
    - キーワード化して動作を提供することを提案
- `va_arg`
    - 言語の基礎的な機能であり、`import`で使用可能であるべき
    - キーワード化して動作を提供することを提案
- `errno`
    - 現在解決案はない
- `ATOMIC_XXX_LOCK_FREE`
    - これらのマクロはサポートされる場合にコンパイラによって定義される（モジュールからエクスポートする必要がない）
- `ATOMIC_FLAG_INIT`
    - C23ライブラリで削除されているため、削除すれば解決

この提案では必ずしも個別の解決策全てを提案しておらず、他の提案に委ねている部分があります。

- [モジュール - cpprefjp](https://cpprefjp.github.io/module.html)
- [P2654R0 進行状況](https://github.com/cplusplus/papers/issues/1437)
