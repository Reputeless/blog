# ［C++］モジュールインポート時の動的初期化順序

ほぼほぼ、2019年12月のBelfast会議で採択された[P1874R1](http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2019/p1874r1.html)の和訳です。

### P1874R1前夜の大問題

P1874R1が採択される以前のモジュールはほとんど完成していたはずですが、以下のような何の変哲も無い？コードが未定義動作に陥るという罠がありました。

```cpp
import <iostream>;  // <iostream>ヘッダユニットのインポート

struct G {
  G() {
    std::cout << "Constructing\n";
  }
};

G g{};  // Undefined Behaior!?
```

C++20においては通常のC++ライブラリヘッダをヘッダユニットとしてインポートできます。ヘッダユニットはそれが1つのモジュールかつ1つの翻訳単位として個別にコンパイルされ、インポートによってその外部リンケージを持つ宣言がインポート先の翻訳単位の名前探索で可視となります。

ここで問題なのは、翻訳単位が別れた場合にはグローバル変数（正確には静的記憶域期間を持つ変数）の初期化順序が不定になってしまうことです。`std::cout`は通常グローバルなオブジェクトなので、`main()`関数の開始前に使用した場合に初期化されているかどうか分かりません。この場合、変数`g`と`std::cout`はそれぞれ異なる翻訳単位にあるため、どちらが先に初期化されるのか、あるいは同時に初期化されるのか、コンパイラ様のみぞ知る世界です・・・

同じ翻訳単位にあればほぼその宣言順に初期化されるためこの問題は起きません。つまり、`#include`の場合は問題ないわけです。

この事は、通常のモジュールをインポートして使用するときにも、そのインターフェース単位にあるグローバルな変数について同じことが起こります。

### Clangの実験的実装

Clangのモジュールの実装（experimental）では、この問題を見た目通りに直列化することで解決していました。

```cpp
// H1.h
inline int a = init();

// H2.h
inline int b = init();

// TU.cpp
int c = init();
import "H1.h";  // ヘッダユニットとしてインポート
import "H2.h";  // ヘッダユニットとしてインポート
```

この場合に、`c -> a -> b`の順番で初期化されます。これはClang Module（not C++20 Module）から引き継がれたモデルであり、`import`と`#include`がなるべく同じ意味を持つことを意図したもののようです。

しかし、C++20のモジュールでは`import`はその順序が意味を持たないように規定されているため、このように規定するのは嫌がられたようで、これを基にした別のモデルを採用しました。


### C++20における順序付け規定





### モジュール実装単位の初期化順序（特に規定されない）

同じ事は、モジュールの実装単位においても言えます。C++20時点ではこちらについては特にケアされていません。

- 規定したとしても異なるモジュール間で規定するのがせいぜいで影響が少ないと思われる
    - モジュール内で実装単位間の初期化順序を規定すると、1つのモジュールをビルドする際のビルド順序を規定してしまうことになるため
- モジュール実装単位は、異なるモジュール間の循環する依存関係を構成しうる
    - 自分自身のインターフェースに依存する別のモジュールをインポートできる
- そもそも実装が無いので影響範囲がわからない
- そもそもこの問題を解決するために触れる必要はない

これらのような理由によって先送りされたようです。

なお、モジュール実装パーティションを同モジュール内でインポートすることができますが、この場合はインターフェース依存関係が発生するので、先ほどの規定に沿った順序が定義されます。


おそらくこれらの問題は`make_unique()`がそうであったように単に忘れられていただけでしょう。モジュールは他にも考えることが盛り沢山なので・・・・

### 参考文献

- [P1874R1 Dynamic Initialization Order of Non-Local Variables in Modules](http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2019/p1874r1.html)
- [初期化 - cppreference](https://ja.cppreference.com/w/cpp/language/initialization)